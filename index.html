<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Operalta â€” AI Startup Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
        
        :root {
            --grid-color: #f0f0f0;
            --accent: #5B21B6;
            --color-recording: #ff3b30;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(0, 0, 0, 0.07);
            --glass-shadow: rgba(0, 0, 0, 0.05);
        }
        
        body {
            font-family: 'Space Grotesk', sans-serif;
            background-color: #f7f7f7;
            background-image:
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(to right, var(--grid-color) 1px, #f7f7f7 1px);
            background-size: 20px 20px;
        }

        .font-mono { font-family: 'Space Mono', monospace; }
        .font-grotesk { font-family: 'Space Grotesk', sans-serif; }
        
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 6px var(--glass-shadow);
        }

        .btn-primary {
             background-color: var(--accent); color: white;
        }
        .btn-primary:hover {
            background-color: #4c1d95;
        }

        /* View Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 240px;
            height: 38px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e9e9e9;
            transition: .4s;
            border-radius: 34px;
            display: flex;
            align-items: center;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 30px;
            width: 116px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 34px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input:checked + .slider:before {
            transform: translateX(116px);
        }
        .slider-text {
            position: relative;
            z-index: 1;
            width: 50%;
            text-align: center;
            font-weight: 500;
            color: #777;
            transition: color .4s;
        }
        input:checked + .slider .slider-text:first-child { color: #777; }
        input:checked + .slider .slider-text:last-child { color: #333; }
        input:not(:checked) + .slider .slider-text:first-child { color: #333; }
        input:not(:checked) + .slider .slider-text:last-child { color: #777; }

        /* Sidebar Navigation */
        .nav-link.active {
            background-color: var(--accent);
            color: white;
            box-shadow: 0 2px 5px rgba(91, 33, 182, 0.3);
        }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link:hover { transform: translateX(2px); }

        /* Recording Button */
        #record-btn.recording {
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 59, 48, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); }
        }

        /* Chat UI */
        .chat-bubble { max-width: 80%; }
        .user-bubble { background-color: var(--accent); color: white; }
        .ai-bubble { background-color: #e5e7eb; color: #1f2937; }
        .chat-input-container {
            position: sticky;
            bottom: 0;
            background: rgba(247,247,247, 0.8);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-top: 1px solid var(--grid-color);
        }
         #chat-input { resize: none; }
         #chat-input:focus { box-shadow: 0 0 0 2px var(--accent); border-color: var(--accent); }

         /* Scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        .playbook-category-btn.active {
            background-color: var(--accent);
            color: white;
        }
        .playbook-category-btn {
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="min-h-screen flex flex-col md:flex-row p-4 gap-4">

        <!-- Sidebar -->
        <nav id="sidebar" class="w-full md:w-64 glass-card rounded-xl p-4 flex flex-col">
            <div class="flex items-center gap-3 mb-8">
                <div class="w-10 h-10 bg-purple-200 rounded-lg flex items-center justify-center">
                    <i class="fas fa-rocket text-purple-700"></i>
                </div>
                <h1 class="text-2xl font-bold font-grotesk text-gray-900">Operalta</h1>
            </div>
            
            <div id="ceo-nav" class="space-y-2">
                <a href="#" class="nav-link flex items-center gap-3 p-3 rounded-lg active" onclick="showPage('dashboard')">
                    <i class="fas fa-chart-pie w-5 text-center"></i><span>Dashboard</span>
                </a>
                <a href="#" class="nav-link flex items-center gap-3 p-3 rounded-lg" onclick="showPage('reports')">
                    <i class="fas fa-file-alt w-5 text-center"></i><span>Reports</span>
                </a>
                <a href="#" class="nav-link flex items-center gap-3 p-3 rounded-lg" onclick="showPage('playbooks')">
                    <i class="fas fa-book w-5 text-center"></i><span>Playbooks</span>
                </a>
                <a href="#" class="nav-link flex items-center gap-3 p-3 rounded-lg" onclick="showPage('settings')">
                    <i class="fas fa-cog w-5 text-center"></i><span>Settings</span>
                </a>
            </div>
            
             <div id="vc-nav" class="hidden space-y-2">
                <a href="#" class="nav-link flex items-center gap-3 p-3 rounded-lg active" onclick="showPage('vc-dashboard')">
                    <i class="fas fa-tachometer-alt w-5 text-center"></i><span>Portfolio</span>
                </a>
                <a href="#" class="nav-link flex items-center gap-3 p-3 rounded-lg" onclick="showPage('vc-playbooks')">
                    <i class="fas fa-book-open w-5 text-center"></i><span>Playbook Library</span>
                </a>
                 <a href="#" class="nav-link flex items-center gap-3 p-3 rounded-lg" onclick="showPage('settings')">
                    <i class="fas fa-cog w-5 text-center"></i><span>Settings</span>
                </a>
            </div>

            <div class="mt-auto text-center">
                <label for="view-toggle" class="toggle-switch">
                    <input type="checkbox" id="view-toggle">
                    <span class="slider">
                        <span class="slider-text">Founder</span>
                        <span class="slider-text">Investor</span>
                    </span>
                </label>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 glass-card rounded-xl overflow-hidden flex flex-col">
            <!-- CEO Views -->
            <div id="ceo-view">
                <div id="page-dashboard" class="page p-6 h-full">
                    <h2 class="text-3xl font-bold mb-6">Founder Dashboard</h2>
                     <!-- Placeholder content -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-white/50 p-6 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-2">ARR</h3>
                            <p class="text-3xl font-mono">$1.2M</p>
                            <p class="text-green-600">+12% MoM</p>
                        </div>
                        <div class="bg-white/50 p-6 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-2">Burn Rate</h3>
                            <p class="text-3xl font-mono">-$85k/mo</p>
                            <p class="text-gray-500">14 mos runway</p>
                        </div>
                         <div class="bg-white/50 p-6 rounded-lg shadow-sm">
                            <h3 class="font-bold text-lg mb-2">Active Users</h3>
                            <p class="text-3xl font-mono">1,402</p>
                            <p class="text-green-600">+5% WoW</p>
                        </div>
                    </div>
                </div>
                <div id="page-reports" class="page p-6 h-full hidden">
                     <!-- Recording and Report Generation UI -->
                     <div class="max-w-3xl mx-auto flex flex-col items-center justify-center text-center h-full">
                         <h2 class="text-3xl font-bold mb-4">Create Investor Update</h2>
                         <p class="text-gray-600 mb-8">Record a voice memo of your weekly update. The AI will transcribe, analyze, and draft a professional report for you.</p>
                         
                         <button id="record-btn" class="w-24 h-24 bg-red-500 text-white rounded-full flex items-center justify-center text-4xl shadow-lg transition-transform duration-200 ease-in-out transform hover:scale-105">
                             <i class="fas fa-microphone"></i>
                         </button>
                         <p id="recording-status" class="mt-4 text-gray-500 h-6">Click to start recording</p>
                         
                         <div id="report-generation" class="w-full mt-8 text-left hidden">
                             <h3 class="font-bold text-xl mb-4 text-center">Analysis & Generation</h3>
                             <div class="space-y-4">
                                 <div>
                                     <h4 class="font-semibold">1. Transcription</h4>
                                     <p id="transcription-text" class="text-sm bg-gray-100 p-3 rounded-lg h-24 overflow-y-auto custom-scrollbar"></p>
                                 </div>
                                 <div>
                                     <h4 class="font-semibold">2. AI Analysis</h4>
                                     <pre id="analysis-json" class="text-sm bg-gray-800 text-white p-3 rounded-lg h-32 overflow-y-auto custom-scrollbar"></pre>
                                 </div>
                                 <div>
                                     <h4 class="font-semibold">3. Draft Report</h4>
                                     <div id="draft-report-markdown" class="text-sm bg-gray-100 p-3 rounded-lg h-40 overflow-y-auto custom-scrollbar prose"></div>
                                 </div>
                             </div>
                             <div class="text-center mt-6">
                                 <button id="finalize-report-btn" class="btn-primary font-bold py-2 px-6 rounded-full">Finalize & Share</button>
                             </div>
                         </div>
                     </div>
                </div>
                <div id="page-playbooks" class="page p-6 h-full hidden flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold">AI Co-Pilot</h2>
                        <button id="browse-library-btn" class="text-sm font-medium text-purple-700 hover:text-purple-900">
                           <i class="fas fa-list-ul mr-2"></i> Browse Playbook Library
                        </button>
                    </div>

                    <!-- Conversational AI View -->
                    <div id="ai-chat-view" class="flex-1 flex flex-col overflow-hidden">
                        <div id="chat-history" class="flex-1 p-4 space-y-4 overflow-y-auto custom-scrollbar">
                            <!-- Chat messages will be appended here -->
                        </div>
                        <div class="chat-input-container">
                            <form id="chat-form" class="flex items-center gap-2">
                                <textarea id="chat-input" class="w-full p-2 border rounded-lg focus:outline-none" placeholder="Describe your biggest challenge this week..." rows="1"></textarea>
                                <button type="submit" class="btn-primary rounded-full w-10 h-10 flex-shrink-0 flex items-center justify-center">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Playbook Library View (hidden by default) -->
                    <div id="playbook-library-view" class="hidden">
                         <div id="playbook-category-filters" class="flex flex-wrap gap-2 mb-4">
                             <!-- Categories will be populated here -->
                         </div>
                         <div id="ceo-playbooks-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Playbooks will be populated here -->
                         </div>
                    </div>
                </div>
                <div id="page-settings" class="page p-6 h-full hidden">
                    <h2 class="text-3xl font-bold mb-6">Settings</h2>
                     <div class="max-w-md">
                        <label for="api-key" class="block font-medium mb-1">Gemini API Key</label>
                        <input type="password" id="api-key" class="w-full p-2 border rounded-lg" placeholder="Enter your API key">
                        <button id="save-api-key" class="mt-4 btn-primary font-bold py-2 px-4 rounded-lg">Save Key</button>
                        <p class="text-xs text-gray-500 mt-2">Your API key is stored securely in your browser's local storage.</p>
                    </div>
                </div>
            </div>

             <!-- VC Views -->
            <div id="vc-view" class="hidden">
                <div id="page-vc-dashboard" class="page p-6 h-full">
                    <h2 class="text-3xl font-bold mb-6">Portfolio Overview</h2>
                    <div id="vc-portfolio-list" class="space-y-4">
                         <!-- Portfolio companies will be populated here -->
                    </div>
                </div>
                 <div id="page-vc-playbooks" class="page p-6 h-full hidden">
                    <h2 class="text-3xl font-bold mb-6">Playbook Library</h2>
                    <p class="text-gray-600">Browse and manage the playbooks available to your portfolio companies.</p>
                    <button id="author-playbook-btn" class="my-4 btn-primary font-bold py-2 px-4 rounded-lg">Author New Playbook</button>
                    <!-- Simplified list for VC -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div id="modal-content" class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="modal-title" class="text-xl font-bold">Modal Title</h3>
                <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="p-6 overflow-y-auto prose max-w-none">
                <!-- Modal content goes here -->
            </div>
        </div>
    </div>
    
    <script type="module">
        // Mock Database
        const db = {
            playbooks: [
                 // This will be populated by the detailed knowledge base below
            ],
            playbookKnowledgeBase: {
                // Pre-Seed Playbooks
                "PS.01": {
                    title: "The Product-Market Fit Engine",
                    category: "Product",
                    stage: "Pre-Seed",
                    diagnostic: "Stagnant user growth, high churn after signup, lukewarm user feedback, feature requests are all over the place.",
                    actions: [
                        "Aggressively survey users with the Superhuman PMF question: 'How would you feel if you could no longer use our product?'",
                        "Segment users into 'Very disappointed', 'Somewhat disappointed', and 'Not disappointed'.",
                        "Ignore the latter two groups. Focus exclusively on the 'Very disappointed' cohort.",
                        "Interview these power users to deeply understand their 'why'. What job are they hiring your product to do?",
                        "Build your product roadmap entirely around doubling down on what this core group loves."
                    ],
                    validation: "Are we willing to ignore some users and shrink our potential market in the short term to build something a small group of power users truly loves?",
                    implementation: "Use tools like Tally or SurveyMonkey. Trigger the survey via email after a user has had enough time to experience the core value prop (e.g., 2 weeks).",
                    result: "A crystal-clear, focused product roadmap. A renewed sense of purpose for the team.",
                    impact_metric: "% of users answering 'Very disappointed' (Goal: >40%)"
                },
                "GS.01": {
                    title: "The First 100 Users",
                    category: "Growth",
                    stage: "Pre-Seed",
                    diagnostic: "Product is built, but user count is zero or near-zero. No clear channel for acquiring initial users.",
                    actions: [
                        "Do things that don't scale.",
                        "Manually recruit users from relevant online communities (Reddit, Slack groups, Twitter).",
                        "Personally onboard every single user.",
                        "Write personalized emails. Do not automate anything at this stage.",
                        "Leverage your personal and professional networks."
                    ],
                    validation: "Are we, as founders, willing to spend the majority of our time on manual, non-scalable user acquisition instead of coding?",
                    implementation: "Create a spreadsheet to track every potential user you reach out to. Follow up relentlessly.",
                    result: "A core group of initial users who feel personally invested in the product's success.",
                    impact_metric: "Number of active, engaged users."
                },
                // Seed Playbooks
                "GA.01": {
                    title: "Finding Your Scalable GTM Channel",
                    category: "Growth",
                    stage: "Seed",
                    diagnostic: "Initial traction is strong but comes from non-scalable sources (founder selling, word-of-mouth). Growth is linear, not exponential.",
                    actions: [
                        "Identify the top 3 potential scalable channels (e.g., PLG, Content Marketing, Paid Ads).",
                        "Run disciplined, time-boxed experiments in each channel with a clear hypothesis and budget.",
                        "Track metrics obsessively (CAC, conversion rates, payback period).",
                        "Kill losing experiments quickly and ruthlessly.",
                        "Once a winning channel is identified, pour resources into it and scale aggressively."
                    ],
                    validation: "Are we willing to accept that our initial assumptions about our GTM strategy might be wrong and let the data guide us?",
                    implementation: "Use a simple sprint process for each channel experiment. Hold weekly reviews to assess progress against goals.",
                    result: "Identification of at least one repeatable, scalable customer acquisition channel.",
                    impact_metric: "Customer Acquisition Cost (CAC) and LTV/CAC Ratio."
                },
                "PA.04": {
                    title: "Addressing Technical Debt",
                    category: "Product",
                    stage: "Seed",
                    diagnostic: "Shipping velocity is slowing down. Small changes cause unpredictable bugs. Engineers are losing motivation and express frustration with the 'brittle' codebase.",
                    actions: [
                        "Declare a 'fix-it' sprint or allocate a percentage of every sprint (e.g., 20%) to tech debt.",
                        "Create a prioritized backlog of tech debt items based on their impact on developer velocity and system stability.",
                        "Focus on improving automated test coverage.",
                        "Refactor the most painful parts of the codebase.",
                        "Communicate to the board and company that you are intentionally slowing down feature development to increase long-term speed."
                    ],
                    validation: "Are we willing to trade short-term feature output for long-term stability and developer productivity?",
                    implementation: "Use code quality tools to identify hotspots. Track developer sentiment through informal check-ins. Make tech debt a regular part of sprint planning.",
                    result: "Improved developer morale, increased shipping velocity, and a more stable platform.",
                    impact_metric: "Cycle Time (from commit to deploy) and Bug Rate."
                },
                 // Add more playbooks from the document here...
            },
            reports: [
                { id: 1, company: 'Starlight AI', date: '2025-10-06', status: 'Submitted', content: '...' },
                { id: 2, company: 'Momentum', date: '2025-10-05', status: 'Submitted', content: '...' },
            ],
            portfolio: [
                { name: 'Starlight AI', ceo: 'Dr. Elena Vance', health: 'green', arr: '$2.1M', growth: '+15% MoM' },
                { name: 'Momentum', ceo: 'Alex Chen', health: 'yellow', arr: '$850k', growth: '+5% MoM' },
                { name: 'QuantumLeap', ceo: 'Ben Carter', health: 'red', arr: '$300k', growth: '-2% MoM' },
            ],
        };

        // Populate playbooks from the knowledge base
        db.playbooks = Object.entries(db.playbookKnowledgeBase).map(([code, data]) => ({
            id: code,
            ...data
        }));


        // UI Elements
        const ui = {
            viewToggle: document.getElementById('view-toggle'),
            ceoView: document.getElementById('ceo-view'),
            vcView: document.getElementById('vc-view'),
            ceoNav: document.getElementById('ceo-nav'),
            vcNav: document.getElementById('vc-nav'),
            sidebar: document.getElementById('sidebar'),
            apiKeyInput: document.getElementById('api-key'),
            saveApiKeyBtn: document.getElementById('save-api-key'),
            recordBtn: document.getElementById('record-btn'),
            recordingStatus: document.getElementById('recording-status'),
            reportGenerationDiv: document.getElementById('report-generation'),
            transcriptionText: document.getElementById('transcription-text'),
            analysisJson: document.getElementById('analysis-json'),
            draftReportMarkdown: document.getElementById('draft-report-markdown'),
            finalizeReportBtn: document.getElementById('finalize-report-btn'),
            modal: document.getElementById('modal'),
            modalContent: document.getElementById('modal-content'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            playbookCategoryFilters: document.getElementById('playbook-category-filters'),
            ceoPlaybooksList: document.getElementById('ceo-playbooks-list'),
            vcPortfolioList: document.getElementById('vc-portfolio-list'),
            // New AI Chat UI elements
            aiChatView: document.getElementById('ai-chat-view'),
            playbookLibraryView: document.getElementById('playbook-library-view'),
            browseLibraryBtn: document.getElementById('browse-library-btn'),
            chatHistory: document.getElementById('chat-history'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
        };

        // Global State
        let currentView = 'ceo';
        let currentPage = 'dashboard';
        let geminiApiKey = localStorage.getItem('geminiApiKey') || '';
        let dictationService;

        // --- Core Services ---
        
        class DictationService {
             // ... [omitted for brevity - same as index-2.html]
        }
        
        class ConversationalAIService {
            constructor(apiKey, knowledgeBase, uiElements) {
                this.apiKey = apiKey;
                this.apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${this.apiKey}`;
                this.knowledgeBase = knowledgeBase;
                this.ui = uiElements;
                this.state = {
                    phase: 'DIAGNOSING', // DIAGNOSING, RECOMMENDING, OPERATIONALIZING_STEP_*, FEEDBACK
                    activePlaybook: null,
                    currentStep: 0,
                };
                this.initialize();
            }

            initialize() {
                this.addMessage('ai', "Welcome. I'm your AI Co-Pilot. To get started, please describe the single biggest challenge you're facing this week.");
                this.ui.chatForm.addEventListener('submit', this.handleUserInput.bind(this));
            }

            async handleUserInput(e) {
                e.preventDefault();
                const userInput = this.ui.chatInput.value.trim();
                if (!userInput) return;

                this.addMessage('user', userInput);
                this.ui.chatInput.value = '';
                this.ui.chatInput.style.height = 'auto'; // Reset height
                this.setLoading(true);

                try {
                    switch (this.state.phase) {
                        case 'DIAGNOSING':
                            await this.diagnoseProblem(userInput);
                            break;
                        case 'RECOMMENDING':
                            // Handle user feedback on recommendation, e.g., "Yes" or "No"
                            if (userInput.toLowerCase().includes('yes') || userInput.toLowerCase().includes('ok')) {
                                this.startOperationalization();
                            } else {
                                this.resetConversation();
                                this.addMessage('ai', "I understand. Let's try again. What's the biggest challenge on your mind?");
                            }
                            break;
                        case 'OPERATIONALIZING':
                             if (userInput.toLowerCase().includes('next') || userInput.toLowerCase().includes('ok') || userInput.toLowerCase().includes('yes')) {
                                this.advanceStep();
                            } else if (userInput.toLowerCase().includes('restart')) {
                                this.resetConversation();
                                this.addMessage('ai', "Let's start over. What is your current main challenge?");
                            }
                            else {
                                // For more complex interactions, you could send this to the LLM for a nuanced response
                                this.addMessage('ai', "Got it. When you're ready to proceed to the next step, just say 'next'.");
                            }
                            break;
                        // default:
                        //     this.addMessage('ai', "I'm not sure how to handle that right now.");
                    }
                } catch (error) {
                    console.error("AI Service Error:", error);
                    this.addMessage('ai', "Sorry, I encountered an error. Please check your API key and connection, then try again.");
                } finally {
                    this.setLoading(false);
                }
            }
            
            async diagnoseProblem(userInput) {
                const systemPrompt = `You are an AI startup advisor. Your task is to diagnose a founder's problem and match it to a specific playbook from the provided knowledge base.
                Analyze the user's message.
                Compare it to the 'diagnostic' field of each playbook in the JSON knowledge base.
                Respond ONLY with the unique code (e.g., "PS.01", "GA.01") of the best-matching playbook. Do not add any other text, explanation, or punctuation.

                Knowledge Base:
                ${JSON.stringify(this.knowledgeBase)}
                `;

                const responseText = await this.makeApiCall(systemPrompt, userInput);
                const playbookCode = responseText.trim().replace(/"/g, ''); // Clean up response

                if (this.knowledgeBase[playbookCode]) {
                    this.state.activePlaybook = this.knowledgeBase[playbookCode];
                    this.state.phase = 'RECOMMENDING';
                    this.addMessage('ai', `Thank you for sharing. It sounds like you're dealing with symptoms related to: **${this.state.activePlaybook.diagnostic}**`);
                    setTimeout(() => {
                         this.addMessage('ai', `Based on that, I recommend we focus on Playbook **${playbookCode}: ${this.state.activePlaybook.title}**. This is designed to address exactly this kind of challenge. Does that sound like the right focus for now?`);
                    }, 1000);
                } else {
                    this.addMessage('ai', "I'm sorry, I couldn't identify a specific playbook for that challenge. Could you please describe it in a different way?");
                }
            }

            startOperationalization() {
                this.state.phase = 'OPERATIONALIZING';
                this.state.currentStep = 0;
                this.addMessage('ai', `Great. Let's walk through the playbook step-by-step. There are 6 key steps.`);
                setTimeout(() => this.presentStep(), 500);
            }

            presentStep() {
                const playbook = this.state.activePlaybook;
                if (!playbook) return;

                let message = '';
                switch(this.state.currentStep) {
                    case 0: // Diagnostic
                        message = `**Step 1: Confirm the Diagnostic.** The playbook describes the symptoms as: *"${playbook.diagnostic}"*. Does this accurately reflect what you're experiencing?`;
                        break;
                    case 1: // Recommended Actions
                        message = `**Step 2: Recommended Actions.** Here are the core plays to run:\n\n<ul class='list-disc pl-5'>${playbook.actions.map(action => `<li>${action}</li>`).join('')}</ul>`;
                        break;
                    case 2: // Founder Validation
                         message = `**Step 3: Founder Validation.** This is a critical strategic gut-check. You need to ask yourself: *"${playbook.validation}"* \n\nThis is a go/no-go decision. How do you feel about that?`;
                        break;
                    case 3: // Implementation
                        message = `**Step 4: Implementation.** Here's how to put this into practice: *"${playbook.implementation}"*. \n\nThis provides a concrete starting point.`;
                        break;
                    case 4: // Expected Result
                        message = `**Step 5: Expected Result.** If we execute this playbook correctly, the expected outcome is: *"${playbook.result}"*`;
                        break;
                    case 5: // Measured Impact
                        message = `**Step 6: Measured Impact.** To know if we're succeeding, we must track a specific metric. The key KPI for this playbook is: **${playbook.impact_metric}**.`;
                        this.addMessage('ai', message);
                        setTimeout(() => this.concludePlaybook(), 1000);
                        return; // Exit here to avoid the "say next" message
                    default:
                        this.resetConversation();
                        this.addMessage('ai', "We've completed the playbook. Let's start over. What's your next challenge?");
                        return;
                }
                 this.addMessage('ai', message);
                 if (this.state.currentStep < 5) {
                    setTimeout(() => this.addMessage('ai', "Say 'next' when you're ready to proceed.", 'subtle'), 500);
                 }
            }

            advanceStep() {
                this.state.currentStep++;
                this.presentStep();
            }

            concludePlaybook() {
                this.addMessage('ai', "You have a clear plan. This is a huge step. I'll set a reminder to check back in a few weeks on how your key metric is progressing. Excellent work.");
                this.state.phase = 'FEEDBACK'; // Or reset
            }
            
            resetConversation() {
                this.state.phase = 'DIAGNOSING';
                this.state.activePlaybook = null;
                this.state.currentStep = 0;
            }

            async makeApiCall(systemPrompt, userPrompt) {
                 if (!this.apiKey) {
                    throw new Error("API key is not set.");
                }
                const payload = {
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: userPrompt }] }],
                };
                const response = await fetch(this.apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            }
            
            addMessage(sender, text, type = 'normal') {
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble p-3 rounded-lg ${sender === 'user' ? 'self-end user-bubble' : 'self-start ai-bubble'}`;
                
                if (type === 'subtle') {
                   bubble.classList.add('opacity-75', 'italic', 'text-sm');
                }

                // Basic markdown for bold and lists
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                bubble.innerHTML = text;
                
                if (sender === 'ai') {
                    const icon = document.createElement('div');
                    icon.className = 'w-8 h-8 bg-purple-200 rounded-full flex items-center justify-center mr-2 flex-shrink-0';
                    icon.innerHTML = `<i class="fas fa-robot text-purple-700"></i>`;
                    const container = document.createElement('div');
                    container.className = 'flex items-start';
                    container.appendChild(icon);
                    container.appendChild(bubble);
                    this.ui.chatHistory.appendChild(container);
                } else {
                    const container = document.createElement('div');
                    container.className = 'flex justify-end';
                    container.appendChild(bubble);
                    this.ui.chatHistory.appendChild(container);
                }
                this.ui.chatHistory.scrollTop = this.ui.chatHistory.scrollHeight;
            }

            setLoading(isLoading) {
                 const existingSpinner = this.ui.chatHistory.querySelector('.spinner');
                 if (isLoading) {
                    if(!existingSpinner) {
                        const spinnerContainer = document.createElement('div');
                        spinnerContainer.className = 'spinner flex items-start';
                        spinnerContainer.innerHTML = `
                            <div class="w-8 h-8 bg-purple-200 rounded-full flex items-center justify-center mr-2 flex-shrink-0"><i class="fas fa-robot text-purple-700"></i></div>
                            <div class="ai-bubble p-3 rounded-lg"><span class="animate-pulse">...</span></div>
                        `;
                        this.ui.chatHistory.appendChild(spinnerContainer);
                        this.ui.chatHistory.scrollTop = this.ui.chatHistory.scrollHeight;
                    }
                } else {
                    if (existingSpinner) {
                        existingSpinner.remove();
                    }
                }
            }
        }
        
        // --- UI Functions ---

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');
            
            const navId = currentView === 'ceo' ? '#ceo-nav' : '#vc-nav';
            document.querySelectorAll(`${navId} .nav-link`).forEach(link => link.classList.remove('active'));
            document.querySelector(`${navId} a[onclick="showPage('${pageId}')"]`).classList.add('active');
            currentPage = pageId;
        }

        function toggleView() {
            currentView = ui.viewToggle.checked ? 'vc' : 'ceo';
            if (currentView === 'ceo') {
                ui.ceoView.classList.remove('hidden');
                ui.vcView.classList.add('hidden');
                ui.ceoNav.classList.remove('hidden');
                ui.vcNav.classList.add('hidden');
                showPage('dashboard');
            } else {
                ui.ceoView.classList.add('hidden');
                ui.vcView.classList.remove('hidden');
                ui.ceoNav.classList.add('hidden');
                ui.vcNav.classList.remove('hidden');
                showPage('vc-dashboard');
            }
        }

        function saveApiKey() {
            geminiApiKey = ui.apiKeyInput.value;
            localStorage.setItem('geminiApiKey', geminiApiKey);
            alert('API Key saved!');
            // Re-initialize services that depend on the key
            initializeServices();
        }
        
        function populateCeoPlaybooks() {
            const activeCategories = [...ui.playbookCategoryFilters.querySelectorAll('.playbook-category-btn.active')].map(btn => btn.dataset.category);
            
            const filteredPlaybooks = activeCategories.length === 0 
                ? db.playbooks 
                : db.playbooks.filter(p => activeCategories.includes(p.category));

            ui.ceoPlaybooksList.innerHTML = filteredPlaybooks.map(playbook => `
                <div class="bg-white/60 p-4 rounded-lg shadow-sm">
                    <span class="text-xs font-mono bg-purple-100 text-purple-800 px-2 py-1 rounded-full">${playbook.id}</span>
                    <h3 class="font-bold mt-2">${playbook.title}</h3>
                    <p class="text-sm text-gray-600">${playbook.category} - ${playbook.stage}</p>
                    <button class="text-sm font-bold text-purple-700 mt-3 playbook-link" data-playbook-id="${playbook.id}">View Playbook &rarr;</button>
                </div>
            `).join('');

            // Re-add event listeners
             document.querySelectorAll('.playbook-link').forEach(link => link.addEventListener('click', (e) => { 
                e.preventDefault(); 
                showPlaybookModal(e.currentTarget.dataset.playbookId); 
            }));
        }
        
        function populatePlaybookCategories() {
            const categories = [...new Set(db.playbooks.map(p => p.category))];
            ui.playbookCategoryFilters.innerHTML = categories.map(cat => `
                <button class="playbook-category-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-full text-sm" data-category="${cat}">
                    ${cat}
                </button>
            `).join('');
        }

        function showPlaybookModal(playbookId) {
            const playbook = db.playbookKnowledgeBase[playbookId];
            if (!playbook) return;
            ui.modalTitle.textContent = `${playbookId}: ${playbook.title}`;
            ui.modalBody.innerHTML = `
                <h4>Diagnostic Symptoms</h4>
                <p>${playbook.diagnostic}</p>
                <h4>Recommended Actions</h4>
                <ul>${playbook.actions.map(a => `<li>${a}</li>`).join('')}</ul>
                <h4>Founder Validation Question</h4>
                <p><em>${playbook.validation}</em></p>
                <h4>Implementation Guide</h4>
                <p>${playbook.implementation}</p>
                <h4>Expected Result</h4>
                <p>${playbook.result}</p>
                <h4>Key Metric to Measure Impact</h4>
                <p><strong>${playbook.impact_metric}</strong></p>
            `;
            ui.modal.classList.remove('hidden');
        }

        function populateVcPortfolio() {
             ui.vcPortfolioList.innerHTML = db.portfolio.map(company => `
                <div class="bg-white/60 p-4 rounded-lg shadow-sm flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <span class="w-3 h-3 rounded-full ${company.health === 'green' ? 'bg-green-500' : company.health === 'yellow' ? 'bg-yellow-500' : 'bg-red-500'}"></span>
                        <div>
                            <h3 class="font-bold">${company.name}</h3>
                            <p class="text-sm text-gray-600">${company.ceo}</p>
                        </div>
                    </div>
                    <div class="text-right">
                         <p class="font-mono text-lg">${company.arr}</p>
                         <p class="text-sm ${company.growth.startsWith('+') ? 'text-green-600' : 'text-red-600'}">${company.growth}</p>
                    </div>
                    <button class="text-sm font-bold text-purple-700">View Report &rarr;</button>
                </div>
            `).join('');
        }
        
        function hideModal() {
            ui.modal.classList.add('hidden');
        }

        function togglePlaybookView() {
            const isChatVisible = !ui.aiChatView.classList.contains('hidden');
            if (isChatVisible) {
                ui.aiChatView.classList.add('hidden');
                ui.playbookLibraryView.classList.remove('hidden');
                ui.browseLibraryBtn.innerHTML = `<i class="fas fa-comments mr-2"></i> Use AI Co-Pilot`;
            } else {
                ui.aiChatView.classList.remove('hidden');
                ui.playbookLibraryView.classList.add('hidden');
                ui.browseLibraryBtn.innerHTML = `<i class="fas fa-list-ul mr-2"></i> Browse Playbook Library`;
            }
        }
        
        function adjustTextareaHeight() {
            ui.chatInput.style.height = 'auto';
            ui.chatInput.style.height = (ui.chatInput.scrollHeight) + 'px';
        }

        // --- Initialization ---

        function initializeServices() {
            if (geminiApiKey) {
                dictationService = new DictationService(geminiApiKey);
                new ConversationalAIService(geminiApiKey, db.playbookKnowledgeBase, ui);
            } else {
                 console.warn("Gemini API Key not found. AI features will be disabled.");
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Event Listeners
            ui.viewToggle.addEventListener('change', toggleView);
            ui.saveApiKeyBtn.addEventListener('click', saveApiKey);
            ui.modalCloseBtn.addEventListener('click', hideModal);
            ui.modal.addEventListener('click', (e) => {
                if (e.target === ui.modal) hideModal();
            });
            ui.playbookCategoryFilters.addEventListener('click', (e) => {
                const targetButton = e.target.closest('.playbook-category-btn');
                if (targetButton) {
                    targetButton.classList.toggle('active');
                    populateCeoPlaybooks();
                }
            });
            ui.browseLibraryBtn.addEventListener('click', togglePlaybookView);
            ui.chatInput.addEventListener('input', adjustTextareaHeight);

            // Initial Load
            ui.apiKeyInput.value = geminiApiKey;
            initializeServices();
            populatePlaybookCategories();
            populateCeoPlaybooks();
            populateVcPortfolio();
            showPage('dashboard'); // Start on the dashboard
        });
    </script>
</body>
</html>
